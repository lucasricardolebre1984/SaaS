{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://automaniaai.com.br/fabio/schemas/orchestration/base.schema.json",
  "title": "Orchestration Base Contracts",
  "type": "object",
  "$defs": {
    "moduleId": {
      "type": "string",
      "enum": [
        "mod-01-owner-concierge",
        "mod-02-whatsapp-crm",
        "mod-03-clientes",
        "mod-04-agenda",
        "mod-05-faturamento-cobranca"
      ]
    },
    "actorType": {
      "type": "string",
      "enum": ["owner", "agent", "system", "customer"]
    },
    "channelType": {
      "type": "string",
      "enum": ["ui-chat", "ui-avatar", "whatsapp", "api", "scheduler", "billing"]
    },
    "actorRef": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "actor_id": { "type": "string", "minLength": 1 },
        "actor_type": { "$ref": "#/$defs/actorType" },
        "channel": { "$ref": "#/$defs/channelType" }
      },
      "required": ["actor_id", "actor_type", "channel"]
    },
    "commandEnvelope": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "schema_version": { "type": "string", "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$" },
        "kind": { "const": "command" },
        "command_id": { "type": "string", "format": "uuid" },
        "name": { "type": "string", "pattern": "^[a-z0-9]+(\\.[a-z0-9]+)+$" },
        "tenant_id": { "type": "string", "minLength": 1 },
        "source_module": { "$ref": "#/$defs/moduleId" },
        "target_module": { "$ref": "#/$defs/moduleId" },
        "created_at": { "type": "string", "format": "date-time" },
        "correlation_id": { "type": "string", "format": "uuid" },
        "causation_id": { "type": "string", "format": "uuid" },
        "trace_id": { "type": "string", "minLength": 8 },
        "actor": { "$ref": "#/$defs/actorRef" },
        "payload": { "type": "object" }
      },
      "required": [
        "schema_version",
        "kind",
        "command_id",
        "name",
        "tenant_id",
        "source_module",
        "target_module",
        "created_at",
        "correlation_id",
        "trace_id",
        "actor",
        "payload"
      ]
    },
    "eventEnvelope": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "schema_version": { "type": "string", "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$" },
        "kind": { "const": "event" },
        "event_id": { "type": "string", "format": "uuid" },
        "name": { "type": "string", "pattern": "^[a-z0-9]+(\\.[a-z0-9]+)+$" },
        "tenant_id": { "type": "string", "minLength": 1 },
        "source_module": { "$ref": "#/$defs/moduleId" },
        "target_module": { "$ref": "#/$defs/moduleId" },
        "emitted_at": { "type": "string", "format": "date-time" },
        "correlation_id": { "type": "string", "format": "uuid" },
        "causation_id": { "type": "string", "format": "uuid" },
        "trace_id": { "type": "string", "minLength": 8 },
        "status": { "type": "string", "enum": ["accepted", "completed", "failed", "info"] },
        "payload": { "type": "object" }
      },
      "required": [
        "schema_version",
        "kind",
        "event_id",
        "name",
        "tenant_id",
        "source_module",
        "target_module",
        "emitted_at",
        "correlation_id",
        "trace_id",
        "payload"
      ]
    }
  }
}
