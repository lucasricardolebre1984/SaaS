# STATE

Last update: 2026-02-25
Active phase: Implement (milestone 2 owner settings multimodal slice)
Active feature: milestone-2-owner-settings-multimodal-slice

## Current Decisions
1. Use creation-with-controlled-migration strategy (not direct replacement of fabio2).
2. Keep fabio2 production flow stable while fabio matures.
3. Work in phased specs to avoid scope pollution.
4. Track both engineering and financial metrics from the start.

## Anti-pollution Protocol
- FOCO: continue current phase only.
- ESTACIONAR: store new idea in backlog, no immediate implementation.
- MUDANCA CRITICA: evaluate impact before changing active scope.
- TROCAR FASE: allowed only after phase checklist is complete.

## Open Risks
- Hidden coupling between backend services in fabio2.
- Inconsistent docs vs runtime behavior in legacy areas.
- Scope creep during architecture bootstrap.

## Mitigations
- Brownfield docs maintained as source of truth.
- Task gating with explicit acceptance criteria.
- Weekly architecture review before new migrations.

## Session Notes
- fabio repo initialized and linked to GitHub.
- fabio2 analyzed for stack, architecture, integrations, and tests.
- .specs baseline created in fabio.
- STD-001 completed: canonical module command/event contracts published in libs/core/orchestration-contracts (JSON Schema + TS/Python stubs).
- SKL-005 completed: daily bootstrap script added in tools/start-day.ps1 (optional skills install + context load + kickoff prompt).
- SKL-006 completed: end-of-day checkpoint script added in tools/end-day.ps1 (work/cost logging + pending tasks + next-day command).
- STD-002 completed: CRM lead funnel/campaign/cobranca domain model and transition test draft published for module 02.
- STD-003 completed: baseline relational model with table ownership map and ER draft published in libs/core/data-model.
- STD-004 completed: module 01 multimodal interaction API contract and continuous chat/avatar state model published.
- STD-005 completed: evolution integration baseline published for module 02 (container, webhook, outbound queue, checklist).
- STD-006 completed: tenant persona packaging baseline published with schemas, YAML templates, and sample tenant pack validation script.
- STD-007 completed: observability and finops maps published with explicit formula linkage to METRICS.md.
- Nx workspace runtime skeleton bootstrapped with project graph and target wiring.
- Contract checks automated via Nx target `contract-tests:contract-checks`.
- Executable contract tests available via Nx target `contract-tests:test`.
- Foundation tasks FND-002..FND-006 finalized with explicit evidence.
- Runtime dual concierge slice implemented in app-platform-api with contract-validated endpoints.
- Runtime tests added and passing via `nx run app-platform-api:test`.
- Runtime orchestration stub now emits validated command/event envelopes with in-memory trace endpoints and preserved correlation id.
- Runtime now persists orchestration envelopes in durable NDJSON storage and applies policy-driven downstream task routing.
- Runtime now has queue/worker boundary for module-task lifecycle with durable queue rehydration.
- Runtime store now supports pluggable backend (`file` default, `postgres` adapter) with SQL baseline for relational persistence.
- Runtime Postgres checkpoint validated with real local DB via `npm run smoke:postgres` and persisted row assertions.
- Postgres smoke stack is explicitly isolated in Docker project `fabio-postgres-smoke` (no shared container/volume with `fabio2`).
- Backend switch operational runbook finalized with explicit rollback path (`file` backend toggle).
- Runtime CI workflow published with two-stage gate: contracts/runtime tests + Postgres smoke.
- Started feature `mod-03-clientes-slice` with draft spec/design/tasks for first domain migration beyond runtime foundation.
- Module 03 contracts published (`customer-create`, `customer-list`, `customer-events`) and integrated into contract checks.
- Module 03 runtime implemented with customer store abstraction (file + postgres) and endpoints `POST/GET /v1/customers`.
- Lead conversion mapper (`mod-02 -> mod-03`) implemented with origin/source validation guards.
- Orchestration events expanded with `customer.created` and `customer.updated`, preserving correlation trace flow.
- Runtime and contract gates validated:
  - `npx nx run app-platform-api:test`
  - `npx nx run contract-tests:contract-checks`
  - `npm run smoke:postgres`
- Opened and implemented `mod-01-rag-retrieval-slice` with contract-first context retrieval over promoted owner memory.
- Module 01 retrieval contracts published (`context-retrieval-request`, `context-retrieval-response`) and integrated into contract checks.
- Runtime retrieval endpoint implemented:
  - `POST /v1/owner-concierge/context/retrieve`
- Retrieval strategy baseline added as vector-ready lexical scorer:
  - strategy `lexical-salience-v1`
  - combines term overlap, tag overlap, and salience score
  - returns `embedding_ref` and ranking evidence (`matched_terms`, `matched_tags`, `score`)
- Postgres smoke flow expanded to cover retrieval checkpoint after memory promotion.
- Runtime and contract gates validated:
  - `npx nx run app-platform-api:test`
  - `npx nx run contract-tests:contract-checks`
  - `npm run smoke:postgres`
- Opened and implemented `mod-01-owner-memory-slice` with contract-first owner memory/context runtime.
- Module 01 memory contracts published (`memory-entry-create`, `memory-entry-list`, `context-promotion`, `context-summary`) and integrated into contract checks.
- Module 01 runtime implemented with pluggable owner memory store (`file` + `postgres`) and endpoints:
  - `POST /v1/owner-concierge/memory/entries`
  - `GET /v1/owner-concierge/memory/entries`
  - `POST /v1/owner-concierge/context/promotions`
  - `GET /v1/owner-concierge/context/summary`
- Orchestration events expanded with `owner.context.promoted` for auditable context-learning flow.
- Postgres smoke flow expanded to cover owner memory create/promote and persisted row assertions in `owner_memory_entries` and `owner_context_promotions`.
- Runtime and contract gates validated:
  - `npx nx run app-platform-api:test`
  - `npx nx run contract-tests:contract-checks`
  - `npm run smoke:postgres`
- Opened and implemented `mod-02-whatsapp-crm-slice` with contract-first lead runtime and collection worker dispatch.
- Module 02 lead contracts published (`lead-create`, `lead-stage-update`, `lead-list`) and integrated into contract checks.
- Module 02 runtime implemented with pluggable lead store (`file` + `postgres`) and endpoints:
  - `POST /v1/crm/leads`
  - `PATCH /v1/crm/leads/:id/stage`
  - `GET /v1/crm/leads`
  - `POST /internal/worker/crm-collections/drain`
- CRM collection worker now consumes `billing.collection.dispatch.request` commands and emits:
  - `billing.collection.sent`
  - `billing.collection.failed`
- Postgres smoke flow expanded to cover crm lead creation and crm collection worker dispatch.
- Runtime and contract gates validated:
  - `npx nx run app-platform-api:test`
  - `npx nx run contract-tests:contract-checks`
  - `npm run smoke:postgres`
- Opened `mod-04-agenda-slice` with draft `spec/design/tasks` for contract-first agenda migration.
- Module 04 contracts published (`appointment`, `reminder`, `reminder-events`) and integrated into contract checks.
- Module 04 runtime implemented with pluggable agenda store (`file` + `postgres`) and endpoints:
  - `POST /v1/agenda/appointments`
  - `PATCH /v1/agenda/appointments/:id`
  - `POST /v1/agenda/reminders`
  - `GET /v1/agenda/reminders`
- Reminder orchestration flow now emits:
  - `agenda.reminder.scheduled`
  - `agenda.reminder.sent`
  - command `agenda.reminder.dispatch.request` for whatsapp dispatch intent.
- Runtime and contract gates validated:
  - `npx nx run app-platform-api:test`
  - `npx nx run contract-tests:contract-checks`
  - `npm run smoke:postgres`
- Opened `mod-05-faturamento-cobranca-slice` with draft `spec/design/tasks` for contract-first billing migration.
- Module 05 contracts published (`charge-create`, `charge-update`, `charge-list`, `payment-create`, `billing-events`) and integrated into contract checks.
- Module 05 runtime implemented with pluggable billing store (`file` + `postgres`) and endpoints:
  - `POST /v1/billing/charges`
  - `PATCH /v1/billing/charges/:id`
  - `POST /v1/billing/charges/:id/collection-request`
  - `POST /v1/billing/payments`
  - `GET /v1/billing/charges`
- Billing orchestration flow now emits:
  - command `billing.collection.dispatch.request`
  - events `billing.charge.created`, `billing.collection.requested`, `billing.payment.confirmed`
- Postgres smoke flow expanded to cover billing create/collection/payment with persisted row assertions in `billing_charges` and `billing_payments`.
- Runtime and contract gates validated:
  - `npx nx run app-platform-api:test`
  - `npx nx run contract-tests:contract-checks`
  - `npm run smoke:postgres`
- Opened and implemented `mod-02-campaign-followup-slice` with contract-first campaign lifecycle and follow-up automation runtime.
- Module 02 advanced contracts published (`campaign-create`, `campaign-state-update`, `campaign-list`, `followup-create`, `followup-list`) and integrated into contract checks.
- Module 02 advanced runtime implemented with pluggable CRM automation store (`file` + `postgres`) and endpoints:
  - `POST /v1/crm/campaigns`
  - `PATCH /v1/crm/campaigns/:id/state`
  - `GET /v1/crm/campaigns`
  - `POST /v1/crm/followups`
  - `GET /v1/crm/followups`
  - `POST /internal/worker/crm-followups/drain`
- Orchestration events expanded with:
  - `crm.campaign.created`
  - `crm.campaign.state.changed`
  - `crm.followup.scheduled`
  - `crm.followup.sent`
  - `crm.followup.failed`
- Postgres smoke flow expanded to cover crm campaign/follow-up creation, follow-up worker dispatch, and persisted row assertions in `crm_campaigns` and `crm_followups`.
- Runtime and contract gates validated:
  - `npx nx run app-platform-api:test`
  - `npx nx run contract-tests:contract-checks`
  - `npm run smoke:postgres`
- Opened and implemented `mod-01-rag-vector-ready-slice` with deterministic hybrid lexical+vector retrieval strategy.
- Module 01 retrieval contracts updated to support vector-ready query hints and hybrid response scoring fields (`lexical_score`, `vector_score`).
- Retrieval strategy now supports:
  - `lexical-salience-v1` (compatibility path)
  - `hybrid-lexical-vector-v1` (requested by `vector-ready`/hybrid strategy flag)
- Runtime retrieval tests expanded with:
  - vector-ready hybrid retrieval path
  - malformed query embedding validation path
- Runtime and contract gates validated:
  - `npx nx run app-platform-api:test`
  - `npx nx run contract-tests:contract-checks`
  - `npm run smoke:postgres`
- Opened and implemented `mod-01-rag-provider-embeddings-slice` with provider-backed embedding resolution and local deterministic fallback.
- Added runtime embedding provider modes:
  - `auto` (OpenAI when available, fallback local)
  - `openai` (strict provider mode)
  - `local`
  - `off`
- Owner memory create flow now resolves embeddings before persistence and returns deterministic `embedding_error` on strict provider failures.
- Owner memory storage upgraded with internal vector persistence:
  - file adapter stores `embedding_vector` in entry records
  - postgres adapter stores `embedding_vector_json` in `owner_memory_entries`
- Retrieval pipeline now reuses shared semantic utility and consumes persisted vectors when present.
- Runtime and contract gates validated:
  - `npx nx run app-platform-api:test`
  - `npx nx run contract-tests:contract-checks`
  - `npm run smoke:postgres`
- Opened and implemented `mod-01-openai-embedding-success-test-slice` to validate strict OpenAI embedding success path with isolated local mock provider.
- Runtime tests now include:
  - strict openai mode failure without key (`embedding_error`)
  - strict openai mode success with local mock `/embeddings` server and auth check
- Runtime and contract gates validated:
  - `npx nx run app-platform-api:test`
  - `npx nx run contract-tests:contract-checks`
  - `npm run smoke:postgres`
- Opened and implemented `mod-01-owner-memory-reembedding-backfill-slice` for tenant-scoped internal embedding backfill maintenance.
- Owner memory stores now support controlled scan/update for entries missing vectors:
  - `listEntriesMissingEmbedding(tenantId, limit)`
  - `updateEntryEmbedding(tenantId, memoryId, payload)`
- Internal maintenance endpoint implemented:
  - `POST /internal/maintenance/owner-memory/reembed`
  - supports `tenant_id`, `limit`, `dry_run`, and provider `mode` override
- Runtime tests now validate dry-run and execute paths for re-embedding by tenant.
- Runtime and contract gates validated:
  - `npx nx run app-platform-api:test`
  - `npx nx run contract-tests:contract-checks`
  - `npm run smoke:postgres`
- Opened and implemented `mod-01-owner-memory-reembed-scheduler-slice` for controlled tenant schedule execution of maintenance backfill.
- Owner memory maintenance scheduler endpoints implemented:
  - `POST /internal/maintenance/owner-memory/reembed/schedules`
  - `GET /internal/maintenance/owner-memory/reembed/schedules`
  - `POST /internal/maintenance/owner-memory/reembed/schedules/run-due`
- Scheduler persistence published in new store:
  - `apps/platform-api/src/owner-memory-maintenance-store.mjs`
  - tracks `last_run_at`, `next_run_at`, and `last_result` per tenant
- Runtime tests expanded with scheduler lifecycle coverage (upsert/list/run-due dry-run and execute).
- Runtime and contract gates validated:
  - `npx nx run app-platform-api:test`
  - `npx nx run contract-tests:contract-checks`
  - `npm run smoke:postgres`
- Opened and implemented `mod-01-owner-memory-reembed-hardening-slice` for production-grade scheduler controls before Milestone 2.
- Scheduler hardening runtime implemented:
  - `POST /internal/maintenance/owner-memory/reembed/schedules/pause`
  - `POST /internal/maintenance/owner-memory/reembed/schedules/resume`
  - `GET /internal/maintenance/owner-memory/reembed/runs`
  - `POST /internal/maintenance/owner-memory/reembed/schedules/run-due` with `max_concurrency` and `lock_ttl_seconds`
- Tenant lock behavior implemented with stale-lock recovery and deterministic `skipped_locked` path.
- Owner memory maintenance persistence now supports backend parity:
  - file adapter
  - postgres adapter (`owner_memory_reembed_schedules`, `owner_memory_reembed_runs`)
- Orchestration contracts expanded with maintenance events:
  - `owner.memory.reembed.started`
  - `owner.memory.reembed.completed`
  - `owner.memory.reembed.failed`
- Postgres smoke expanded to validate scheduler operational flow and persisted scheduler rows.
- Runtime and contract gates validated:
  - `npx nx run app-platform-api:test`
  - `npx nx run contract-tests:contract-checks`
  - `npm run smoke:postgres`
- Milestone 1 exit checklist closed with explicit GO decision:
  - `.specs/project/MILESTONE-1-EXIT-CHECKLIST.md`
- Roadmap transitioned:
  - Milestone 1 marked completed
  - Milestone 2 marked current
- Opened `milestone-2-ui-shell-slice` to replace console placeholders with runnable visual shell for Module 01 and Module 02.
- Milestone 2 UI shell now includes dual layout system for both consoles:
  - `fabio2` parity mode (legacy visual baseline)
  - `studio` premium mode (modern AI-first visual direction)
- Visual tokenization added for clone-ready branding with palette presets (`ocean`, `forest`, `sunset`) and tenant theme hooks in console runtime.
- M2U-003 completed: real static toolchain wired for UI apps:
  - `tools/build-static-app.mjs` added
  - `app-owner-console` and `app-crm-console` `build/serve` Nx targets now run real commands
- M2U-004 completed with validation evidence:
  - `npx nx run app-owner-console:build`
  - `npx nx run app-crm-console:build`
  - `npx nx run app-owner-console:serve` (HTTP `200` on `127.0.0.1:4401`)
  - `npx nx run app-crm-console:serve` (HTTP `200` on `127.0.0.1:4402`)
- Milestone 2 UI shell slice checkpoint committed and pushed:
  - commit `865e283`
  - branch `main` synchronized with `origin/main`
- Opened new feature docs for template generator/playbook:
  - `.specs/features/milestone-2-template-generator-slice/spec.md`
  - `.specs/features/milestone-2-template-generator-slice/design.md`
  - `.specs/features/milestone-2-template-generator-slice/tasks.md`
- M2T-001..004 completed:
  - template manifest and placeholder model published in `templates/saas-starter` + `docs/templates/manifest.md`
  - generator script implemented: `tools/generate-saas-starter.mjs`
  - package command wired: `npm run generate:saas-starter`
  - dry-run, generation, conflict-protection, and overwrite paths validated
- Generation validation artifact:
  - `.tmp/generated-saas/automania-prime`
- Opened `milestone-2-owner-settings-multimodal-slice` to expand module-01 UX with:
  - module `06 Configuracoes` as fixed last menu item
  - API/integration configuration workspace
  - local API spend metrics by module
  - chat multimodal actions (audio, image, file)
- M2S-001..005 completed in owner-console:
  - dynamic module navigation now renders `06 Configuracoes` as fixed last item
  - runtime/OpenAI/integration settings moved to dedicated configuration workspace
  - local API spend dashboard per module added with reset action
  - chat composer now supports attachment queue (audio, image, file) with contract-compatible payload fields
  - owner-console build and serve checks validated
- M2S-006 completed in owner-console:
  - module `06 Configuracoes` now requires admin password (`191530`) before access
  - topbar now shows lock status badge (`admin: bloqueado/liberado`)
  - runtime card includes `Bloquear Config` action to relock module 06 in current session
- M2S-007 completed in owner-console/runtime contracts:
  - module `06 Configuracoes` now includes Persona 1 and Persona 2 prompt fields with format examples
  - interaction payload supports optional `persona_overrides` in module 01 contract
  - runtime propagates persona overrides to `owner.command.create` and `module.task.create.input`
  - no-persona mode preserved (empty prompts keep neutral baseline behavior)
- Postgres smoke revalidated after Docker Desktop startup with isolated stack:
  - command: `npm run smoke:postgres`
  - status: passed (full end-to-end flow with owner/crm/billing/memory/scheduler)
  - isolation confirmed from `fabio2`: smoke uses compose project `fabio-postgres-smoke` and host port `55432` while `fabio2` uses `5432`
- Project-only skills policy enforced for Codex (`C:\Users\Lucas\.codex\skills`):
  - retained: `.system`, `project-context-loader`, `saas-standard-architect`, `contract-first-migrator`, `metrics-discipline`
  - removed external skill set archive to avoid cross-repo context drift
- `AGENTS.md` updated with mandatory daily commands (`init:day`, `resume:day`, `end:day`) and current active milestone priority.

## Next Checkpoint
Proceed with Milestone 2 exit evaluation checklist and operational handoff docs.

## Legacy Quarantine Policy (critical)
- Legacy code in fabio2 is reference for business behavior, not implementation source.
- Direct copy/paste of route, persona, or context orchestration code is forbidden by default.
- Every migrated domain must define contract-first interfaces before implementation.
- Persona and context flow will be redesigned as explicit modules with boundaries and tests.
- If behavior is unclear, preserve business intent and rewrite implementation cleanly.
- contratos directory copied from fabio2 as approved legacy asset import.

## Scope Decisions (new)
- Closed SaaS model approved with modules 1 to 5.
- Module 01 is owner orchestrator with continuous chat + avatar support.
- Module 02 is WhatsApp CRM concierge integrated with Evolution container.
- Module 03, 04, and 05 are mandatory as reusable neutral core modules.
- Persona remains optional/configurable and tenant-specific.

- agent-skills-cli-mvp MVP completed (skills + trigger matrix + runbook + installer test).
