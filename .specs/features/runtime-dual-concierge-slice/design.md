# Design - runtime-dual-concierge-slice

Status: In Progress
Date: 2026-02-23

## Runtime Surface
- App: `app-platform-api`
- Node HTTP server (no framework dependency)
- Ajv validators loaded from contract artifacts in `libs/`
- Local durable orchestration storage: NDJSON append-only files
- Policy-driven task planner loaded from `apps/platform-api/config/task-routing.policy.json`

## Endpoints
1. `GET /health`
2. `POST /v1/owner-concierge/interaction`
3. `POST /provider/evolution/webhook`
4. `POST /provider/evolution/outbound/validate`
5. `GET /internal/orchestration/commands`
6. `GET /internal/orchestration/events`
7. `GET /internal/orchestration/trace?correlation_id={uuid}`
8. `GET /internal/orchestration/module-task-queue`
9. `POST /internal/worker/module-tasks/drain`

## Validation Strategy
- Owner request validator uses `multimodal-api.schema.json` request node.
- Evolution webhook validator uses `evolution-webhook.schema.json`.
- Outbound queue validator uses `outbound-queue.schema.json`.
- Orchestration envelopes generated by runtime are validated with core contracts:
  - `commands.schema.json`
  - `events.schema.json`

## Orchestration Stub Behavior
- For each accepted owner interaction:
  - emit command envelope `owner.command.create`
  - emit event envelope `owner.command.created`
- For `send_message` operations:
  - infer downstream task route via explicit policy rules and emit `module.task.create`
  - emit `module.task.created`
  - enqueue task for worker processing
- Worker drain endpoint emits:
  - `module.task.accepted`
  - terminal event `module.task.completed` or `module.task.failed` (policy route flag)
- All envelopes share the same `correlation_id` per interaction and are stored in bounded in-memory cache plus durable NDJSON files.
- Queue state is persisted in `module-task-queue.json` with `pending` and `history`.

## Response Pattern
- Success:
  - status `200`
  - normalized response body
- Validation failure:
  - status `400`
  - `{ error: "validation_error", details: [...] }`

## Testing Strategy
- `node:test` integration-style tests boot local ephemeral server.
- Validate:
  - health response
  - valid/invalid owner interaction
  - module-task orchestration trace with correlation integrity
  - queue + worker drain lifecycle (accepted/completed/failed)
  - queue rehydration across app restart
  - valid/invalid webhook
  - valid/invalid outbound queue payload
